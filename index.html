<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
<title>KUDHIN SPLIT — Modern</title>
<link rel="icon" href="data:;base64,iVBORw0KGgo=">
<style>
  :root{
    --blue: #1e88e5;
    --blue-100: #eaf5ff;
    --blue-200: #cfefff;
    --bg: #f6fbff;
    --card: #ffffff;
    --muted: #6b7a8f;
    --danger: #ef5350;
    --ok: #43a047;
    --radius: 14px;
    --shadow: 0 8px 22px rgba(18,35,68,0.06);
    --pill-h: 34px;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:#122033;-webkit-font-smoothing:antialiased}
  .app-shell{max-width:420px;margin:8px auto;height:calc(100dvh - 16px);display:flex;flex-direction:column;box-sizing:border-box;padding:8px}
  header.app-header{
    height:60px;display:flex;align-items:center;justify-content:space-between;gap:8px;
    background:linear-gradient(180deg,var(--blue),#1976d2);color:#fff;padding:10px;border-radius:12px;
    box-shadow:var(--shadow);position:relative;z-index:20;
  }
  .profile{display:flex;align-items:center;gap:10px}
  .avatar{width:42px;height:42px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.12);font-weight:700;font-size:14px}
  .profile .meta{line-height:1}
  .profile .meta .name{font-weight:700;font-size:14px}
  .profile .meta .mobile{font-size:12px;opacity:.9}
  button.icon-btn{background:transparent;border:none;color:#fff;font-size:22px;padding:6px;border-radius:8px;cursor:pointer}
  button.icon-btn:active{transform:scale(.98)}
  .menu-dropdown{position:absolute;right:10px;top:56px;background:#fff;border:1px solid #e8f2ff;border-radius:10px;box-shadow:0 10px 30px rgba(6,16,35,.15);display:none;overflow:hidden;min-width:160px}
  .menu-dropdown button{display:block;width:100%;background:#fff;border:none;text-align:left;padding:10px 12px;font-weight:600;cursor:pointer}
  .menu-dropdown button:hover{background:#f6fbff}
  main.app-main{flex:1;overflow:auto;padding:12px 0;}
  .card{background:var(--card);border-radius:12px;padding:12px;margin-bottom:12px;box-shadow:0 6px 18px rgba(20,40,80,0.04)}
  .row{display:flex;gap:8px;align-items:center}
  .small{font-size:12px;color:var(--muted)}
  input,select,button{font-family:inherit}
  input[type=text],input[type=number],select{width:100%;padding:10px;border-radius:10px;border:1px solid #e6f0fb;background:transparent;box-sizing:border-box;font-size:14px}
  .btn{height:34px;border-radius:10px;padding:0 12px;border:none;cursor:pointer;font-weight:600}
  .btn-primary{background:var(--blue);color:#fff}
  .btn-ghost{background:transparent;border:1px solid rgba(18,40,70,0.08);color:#122033}
  .btn-danger{background:var(--danger);color:#fff}
  .btn-ok{background:var(--ok);color:#fff}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:var(--blue-200);height:var(--pill-h);border:1px solid rgba(18,40,70,0.06);cursor:pointer;user-select:none}
  .pill .dot{width:14px;height:14px;border-radius:50%;background:#fff;display:inline-block;box-shadow:0 1px 2px rgba(0,0,0,0.08)}
  .pill.active{background:linear-gradient(90deg,var(--ok),#2e8b57);color:#fff}
  .table-wrap{overflow:hidden;border-radius:10px;border:1px solid #eef7ff}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:10px;text-align:left}
  thead th{color:var(--muted);font-weight:700;border-bottom:1px solid #f3fbff}
  tbody tr:nth-child(odd){background:#fbfdff}
  .tag{display:inline-block;padding:6px 8px;border-radius:999px;background:#f1fbff;border:1px solid #e2f2ff;font-size:12px}
  .list-row{display:flex;align-items:center;gap:8px;padding:8px;border-radius:10px;border:1px solid #f0f7ff;margin-bottom:8px}
  .list-row .title{font-weight:700}
  .list-row .meta{font-size:12px;color:var(--muted)}
  .list-actions{margin-left:auto;display:flex;gap:8px}
  .remove-sm{background:transparent;border:1px solid rgba(0,0,0,0.06);padding:6px;border-radius:8px;color:var(--danger);font-weight:700;cursor:pointer}
  nav.app-nav{display:flex;gap:8px;justify-content:space-between;background:linear-gradient(180deg,var(--blue-100),#d6eefc);padding:8px;border-radius:12px;position:sticky;bottom:0;margin-top:8px}
  nav.app-nav button{flex:1;border-radius:10px;padding:10px;border:none;background:transparent;color:#034a7a;font-weight:700}
  nav.app-nav button.active{background:#fff;color:var(--blue);box-shadow:0 6px 16px rgba(30,120,210,0.12)}
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,8,23,0.45);z-index:80;padding:18px}
  .modal.open{display:flex}
  .panel{width:min(420px,100%);background:var(--card);border-radius:14px;padding:14px;box-shadow:0 18px 40px rgba(6,16,35,0.2)}
  .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
  .owings-grid{display:grid;grid-template-columns:1fr;gap:10px}
  .owing-card{display:flex;flex-direction:column;padding:12px;border-radius:12px;border:1px solid #eef7ff;background:linear-gradient(180deg,#fff,#fbfdff)}
  .owing-top{display:flex;align-items:center;gap:8px}
  .status{padding:6px 8px;border-radius:999px;font-weight:700;font-size:12px}
  .status.UNPAID{background:#fff0f0;color:#b00000;border:1px solid rgba(239,83,80,0.1)}
  .status.PAID{background:#fff8e6;color:#a97a00;border:1px solid rgba(255,193,7,0.08)}
  .status.RECEIVED{background:#eaf9ef;color:#1b8a57;border:1px solid rgba(76,175,80,0.08)}
  @media (min-width:520px){
    .app-shell{box-shadow:0 12px 36px rgba(6,16,35,0.06);border-radius:18px;padding:16px}
  }
</style>
</head>
<body>

<div class="app-shell" id="appShell">

  <!-- LOGIN SCREEN -->
  <div id="loginScreen">
    <div class="card">
      <div style="font-weight:800;font-size:18px">KUDHIN SPLIT</div>
      <div class="small" style="margin-top:4px">Simple, modern bill splitter</div>
    </div>

    <div class="card">
      <div style="font-weight:700;margin-bottom:8px">Login</div>
      <label class="small">Select user</label>
      <select id="loginSelect" style="margin-bottom:8px"></select>
      <label class="small">Mobile (as password)</label>
      <input id="loginMobile" type="text" placeholder="MOBILE NUMBER" />
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn btn-primary" style="flex:1" onclick="login()">LOGIN</button>
      </div>
      <div class="small" style="margin-top:8px;color:var(--muted)">Choose a user and enter the correct mobile to continue.</div>
    </div>
  </div>

  <!-- APP -->
  <div id="app" style="display:none;flex-direction:column;height:100%">

    <!-- HEADER -->
    <header class="app-header">
      <div class="profile">
        <div class="avatar" id="avatarInitial">K</div>
        <div class="meta">
          <div id="profileName" class="name">-</div>
          <div id="profileMobile" class="mobile small">-</div>
        </div>
      </div>
      <div style="position:relative">
        <button id="hamburger" class="icon-btn" title="Menu">☰</button>
        <div id="menuDropdown" class="menu-dropdown">
          <button onclick="openSettings()">Settings</button>
          <button onclick="signOut()">Sign Out</button>
        </div>
      </div>
    </header>

    <main class="app-main">
      <!-- SPLITTER -->
      <section id="tab-splitter" class="card">
        <div style="display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:8px">
          <div style="display:flex;gap:8px;align-items:center">
            <button class="btn btn-primary" onclick="startAddPerson()">+ Add Person</button>
            <button class="btn btn-primary" onclick="openSharedPopup()">+ Shared Item</button>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <div id="gstToggle" class="pill" onclick="toggleGST()" title="Toggle GST 8%">
              <div class="dot"></div><div style="font-weight:700">GST 8%</div>
            </div>
            <button class="btn btn-ok" onclick="openPreview()">Preview</button>
          </div>
        </div>

        <div class="row" style="gap:8px;margin-bottom:10px;flex-wrap:wrap">
          <div style="flex:1;min-width:150px">
            <label class="small">Bill date</label>
            <input id="billDate" type="date" />
          </div>
          <div style="flex:1;min-width:150px">
            <label class="small">Payer</label>
            <select id="payerSelect"></select>
          </div>
        </div>

        <div style="margin-bottom:10px">
          <label class="small">Vendor</label>
          <select id="vendorSelect"></select>
        </div>

        <div style="margin-bottom:10px">
          <label class="small">Manual Service (Amount) — split <strong>equally</strong></label>
          <input id="manualService" type="number" placeholder="0.00" />
        </div>

        <div style="margin-top:6px">
          <div style="font-weight:700;margin-bottom:8px">Persons</div>
          <div id="personsList"></div>
          <div class="small" id="noPersonsHint" style="display:block;color:var(--muted)">No persons yet — add a person to begin.</div>
        </div>

        <div style="margin-top:12px">
          <div style="font-weight:700;margin-bottom:8px">Shared Items</div>
          <div id="sharedList"></div>
          <div class="small" id="noSharedHint" style="display:block;color:var(--muted)">No shared items — add shared items here.</div>
        </div>
      </section>

      <!-- OWINGS -->
      <section id="tab-owings" class="card" style="display:none">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
          <div style="font-weight:700">Owings & Settlements</div>
          <div class="small" style="color:var(--muted)">Track who owes whom</div>
        </div>
        <div id="owingsArea" class="owings-grid"></div>
      </section>

      <!-- SETTINGS (opened via hamburger only) -->
      <section id="tab-settings" class="card" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:800">Users</div>
            <div class="small" style="color:var(--muted)">Fixed users for login & payer selection</div>
          </div>
        </div>

        <div style="margin-top:8px" id="userListArea"></div>

        <div style="margin-top:12px">
          <div style="font-weight:700">Add Vendor</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="newVendor" type="text" placeholder="Vendor name" />
            <button class="btn btn-primary" onclick="addVendor()">Add</button>
          </div>
          <div id="vendorList" style="margin-top:8px;display:flex;flex-wrap:wrap;gap:8px"></div>
        </div>

        <div style="margin-top:14px;display:flex;gap:8px">
          <button class="btn btn-ghost" onclick="exportData()">Export JSON</button>
          <button class="btn btn-ghost" onclick="clearAll()">Clear All</button>
        </div>
      </section>
    </main>

    <!-- bottom nav (no Settings here) -->
    <nav class="app-nav">
      <button id="nav-splitter" class="active" onclick="switchTab('splitter')">Splitter</button>
      <button id="nav-owings" onclick="switchTab('owings')">Owings</button>
    </nav>

  </div>
</div>

<!-- Modal -->
<div id="modal" class="modal" aria-modal="true" role="dialog">
  <div class="panel">
    <h3 id="modal-title" style="margin:0 0 8px 0;font-size:16px">Title</h3>
    <div id="modal-body"></div>
    <div class="actions">
      <button id="modal-cancel" class="btn btn-ghost" onclick="closeModal()">CANCEL</button>
      <button id="modal-primary" class="btn btn-primary">NEXT</button>
    </div>
  </div>
</div>

<!-- jsPDF (for PDF) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/* ===== storage keys & defaults ===== */
const LS_USERS="KUDHIN_users", LS_VENDORS="KUDHIN_vendors", LS_OWINGS="KUDHIN_owings", LS_BILLS="KUDHIN_bills";
let users = JSON.parse(localStorage.getItem(LS_USERS)) || [
  {name:"MIUSHAAN", mobile:"9996912"},
  {name:"RAYA", mobile:"9996912"},
  {name:"ASLAN", mobile:"9996912"},
  {name:"REESHA", mobile:"9996912"},
  {name:"ZIPPE", mobile:"9996912"},
  {name:"AFU", mobile:"9996912"},
  {name:"APPAL", mobile:"9996912"},
  {name:"IRUFAAN", mobile:"9996912"},
  {name:"ULY", mobile:"9996912"}
];
let vendors = JSON.parse(localStorage.getItem(LS_VENDORS)) || [];
let owings = JSON.parse(localStorage.getItem(LS_OWINGS)) || [];
let bills = JSON.parse(localStorage.getItem(LS_BILLS)) || [];
let billCounter = (bills[bills.length-1]?.billID || 0) + 1;

/* runtime state */
let persons = [];        // [{name, items:[{item,amount}]}]
let sharedItems = [];    // [{item,amount}]
let gstEnabled = false;

/* helpers */
const el = s => document.querySelector(s);
const toUpper = v => (v||"").toString().toUpperCase();
const saveLS = (k,v)=> localStorage.setItem(k, JSON.stringify(v));
const showModal = ()=> el('#modal').classList.add('open');
const hideModal = ()=> el('#modal').classList.remove('open');
const round2 = n => Math.round((Number(n)+Number.EPSILON)*100)/100;
const f2 = n => round2(n).toFixed(2);

/* init */
(function init(){
  updateLoginSelect(); refreshVendorSelect(); refreshVendorList(); updatePayerSelect(); renderUsers(); renderOwings();
  // hamburger menu
  el('#hamburger').addEventListener('click', (e)=>{ e.stopPropagation(); el('#menuDropdown').style.display = (el('#menuDropdown').style.display==='block'?'none':'block'); });
  document.addEventListener('click', ()=>{ el('#menuDropdown').style.display='none'; });
})();

/* ===== LOGIN ===== */
function updateLoginSelect(){ el('#loginSelect').innerHTML = `<option value="">-- SELECT USER --</option>` + users.map((u,i)=>`<option value="${i}">${u.name}</option>`).join(''); }
function login(){
  const idx = parseInt(el('#loginSelect').value,10);
  const mobile = toUpper(el('#loginMobile').value).trim();
  if(Number.isInteger(idx) && users[idx] && toUpper(users[idx].mobile) === mobile){
    const u = users[idx];
    el('#profileName').textContent = u.name;
    el('#profileMobile').textContent = u.mobile;
    el('#avatarInitial').textContent = u.name.slice(0,1) || 'K';
    el('#loginScreen').style.display = 'none';
    el('#app').style.display = 'flex';
    updatePayerSelect(); el('#payerSelect').value = u.name;
  } else alert('INVALID CREDENTIALS');
}
function signOut(){
  // reset transient state but keep saved data
  persons = []; sharedItems = []; gstEnabled = false;
  el('#gstToggle').classList.remove('active');
  renderPersons(); renderShared();
  // reset header
  el('#profileName').textContent = '-'; el('#profileMobile').textContent='-'; el('#avatarInitial').textContent='K';
  // show login
  el('#app').style.display='none'; el('#loginScreen').style.display='block';
  // close dropdown
  el('#menuDropdown').style.display='none';
  // clear login inputs
  el('#loginMobile').value=''; el('#loginSelect').value='';
}
function openSettings(){ switchTab('settings', true); el('#menuDropdown').style.display='none'; }

/* ===== tabs ===== */
function switchTab(tab, fromMenu=false){
  ['splitter','owings','settings'].forEach(t=> el(`#tab-${t}`).style.display='none');
  el(`#tab-${tab}`).style.display='block';
  // bottom nav only for splitter/owings
  document.querySelectorAll('nav.app-nav button').forEach(b=>b.classList.remove('active'));
  if(tab==='splitter') el('#nav-splitter').classList.add('active');
  if(tab==='owings') el('#nav-owings').classList.add('active');
}

/* ===== settings & vendors ===== */
function renderUsers(){ el('#userListArea').innerHTML = users.map(u=>`<div style="padding:8px;border-radius:8px;border:1px solid #f0f8ff;margin-bottom:6px">${u.name} <span class="small" style="color:var(--muted)">(${u.mobile})</span></div>`).join(''); }
function addVendor(){
  const v = toUpper(el('#newVendor').value).trim();
  if(!v) return alert('VENDOR REQUIRED');
  if(vendors.includes(v)) return alert('VENDOR EXISTS');
  vendors.push(v); saveLS(LS_VENDORS,vendors); el('#newVendor').value=''; refreshVendorSelect(); refreshVendorList();
}
function refreshVendorSelect(){ el('#vendorSelect').innerHTML = `<option value="">-- SELECT VENDOR --</option>` + vendors.map(v=>`<option>${v}</option>`).join(''); }
function refreshVendorList(){ el('#vendorList').innerHTML = vendors.map(v=>`<div class="tag">${v}</div>`).join(''); }
function updatePayerSelect(){ el('#payerSelect').innerHTML = `<option value="">-- SELECT --</option>` + users.map(u=>`<option>${u.name}</option>`).join(''); }

/* ===== GST toggle ===== */
function toggleGST(){ gstEnabled = !gstEnabled; el('#gstToggle').classList.toggle('active', gstEnabled); }

/* ===== persons & shared render ===== */
function renderPersons(){
  const wrap = el('#personsList'); wrap.innerHTML = '';
  el('#noPersonsHint').style.display = persons.length ? 'none' : 'block';
  persons.forEach((p,pi)=>{
    const c = document.createElement('div'); c.className='list-row';
    const left = document.createElement('div'); left.innerHTML = `<div class="title">${p.name}</div><div class="meta small">${p.items.length} items • ${f2(p.items.reduce((s,i)=>s+Number(i.amount||0),0))}</div>`;
    const actions = document.createElement('div'); actions.className='list-actions';
    const addBtn = document.createElement('button'); addBtn.className='btn btn-ghost'; addBtn.textContent='Add Item'; addBtn.onclick=()=> startAddItemFor(p.name);
    const rmBtn = document.createElement('button'); rmBtn.className='remove-sm'; rmBtn.textContent='REMOVE'; rmBtn.onclick=()=>{ if(confirm('Remove this person?')){ persons.splice(pi,1); renderPersons(); } };
    actions.appendChild(addBtn); actions.appendChild(rmBtn);
    c.appendChild(left); c.appendChild(actions);

    const box = document.createElement('div'); box.style.marginTop='8px';
    if(p.items.length===0){ box.innerHTML = `<div class="small" style="color:var(--muted)">No items</div>`; }
    else p.items.forEach((it,ii)=>{
      const row = document.createElement('div'); row.style.cssText='display:flex;justify-content:space-between;align-items:center;padding:6px 8px;border-radius:8px;margin-top:6px;background:#fbfdff';
      row.innerHTML = `<div><div style="font-weight:700">${it.item}</div><div class="small" style="color:var(--muted)">${f2(it.amount)}</div></div>`;
      const rm = document.createElement('button'); rm.className='remove-sm'; rm.textContent='x'; rm.onclick=()=>{ p.items.splice(ii,1); renderPersons(); };
      row.appendChild(rm); box.appendChild(row);
    });

    wrap.appendChild(c); wrap.appendChild(box);
  });
}
function renderShared(){
  const wrap = el('#sharedList'); wrap.innerHTML = '';
  el('#noSharedHint').style.display = sharedItems.length ? 'none' : 'block';
  sharedItems.forEach((s,si)=>{
    const row = document.createElement('div'); row.className='list-row';
    row.innerHTML = `<div><div class="title">${s.item}</div><div class="meta small">${f2(s.amount)}</div></div>`;
    const rm = document.createElement('button'); rm.className='remove-sm'; rm.textContent='REMOVE'; rm.onclick=()=>{ sharedItems.splice(si,1); renderShared(); };
    row.appendChild(rm); wrap.appendChild(row);
  });
}

/* ===== multi-step add ===== */
let stepPerson=null, stepItem=null;
function startAddPerson(){ stepPerson=null; stepItem=null; showSelectPerson(); }
function startAddItemFor(name){ stepPerson=name; stepItem=null; showItemName(); }

function openModal(title, bodyHTML, primaryText='NEXT', primaryHandler=null){
  el('#modal-title').textContent = title;
  el('#modal-body').innerHTML = bodyHTML;
  const pbtn = el('#modal-primary'); pbtn.textContent = primaryText; pbtn.onclick = primaryHandler || (()=>{});
  showModal();
}
function closeModal(){ hideModal(); }

function showSelectPerson(){
  const options = users.map(u=>`<option value="${u.name}">${u.name}</option>`).join('');
  openModal('SELECT PERSON', `<select id="selPerson" style="width:100%"><option value="">-- SELECT USER --</option>${options}</select>`, 'NEXT', ()=>{
    const v = toUpper(document.querySelector('#selPerson').value).trim(); if(!v) return alert('SELECT A USER'); stepPerson=v; showItemName();
  });
}
function showItemName(){
  openModal(`ADD ITEM FOR ${stepPerson}`, `<input id="itemName" type="text" placeholder="ITEM NAME" />`, 'NEXT', ()=>{
    const v = toUpper(document.querySelector('#itemName').value).trim(); if(!v) return alert('ENTER ITEM NAME'); stepItem=v; showItemPrice();
  });
}
function showItemPrice(){
  openModal(`ENTER PRICE FOR ${stepItem}`, `
    <input id="itemPrice" type="number" placeholder="AMOUNT" />
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="btnMore" class="btn btn-ghost" style="flex:1">Add more items</button>
      <button id="btnNextPerson" class="btn btn-primary" style="flex:1">Add next person</button>
    </div>
  `, 'SAVE', ()=> doAddItem(false));
  document.querySelector('#btnMore').onclick = ()=> doAddItem(false);
  document.querySelector('#btnNextPerson').onclick = ()=> doAddItem(true);
}
function doAddItem(nextPerson){
  const price = parseFloat(document.querySelector('#itemPrice').value) || 0;
  if(!(price>0)) return alert('ENTER VALID AMOUNT');
  let p = persons.find(x=>x.name===stepPerson);
  if(!p){ p = {name: stepPerson, items:[]}; persons.push(p); }
  p.items.push({item: stepItem, amount: price});
  renderPersons();
  if(nextPerson){ stepPerson=null; stepItem=null; showSelectPerson(); }
  else { stepItem=null; showItemName(); }
}

/* ===== shared popup ===== */
function openSharedPopup(){
  openModal('ADD SHARED ITEM', `<input id="sharedName" type="text" placeholder="ITEM NAME" /><input id="sharedAmt" type="number" placeholder="AMOUNT" style="margin-top:8px" />`, 'ADD', ()=>{
    const n = toUpper(document.querySelector('#sharedName').value).trim(); const a = parseFloat(document.querySelector('#sharedAmt').value)||0;
    if(!n) return alert('ENTER ITEM NAME'); if(!(a>0)) return alert('ENTER VALID AMOUNT'); sharedItems.push({item:n, amount:a}); renderShared(); closeModal();
  });
}

/* ===== totals (manual service split equally; GST on subtotal) ===== */
function computeTotalsDetailed(){
  const peopleCount = persons.length || 1;
  const totalShared = sharedItems.reduce((s,it)=>s + Number(it.amount||0), 0);
  const sharedPerPerson = peopleCount ? (totalShared / peopleCount) : 0;
  const manualTotal = parseFloat(el('#manualService').value) || 0;
  const manualPerPerson = peopleCount ? (manualTotal / peopleCount) : 0;

  const lines = persons.map(p=>{
    const itemsTotal = p.items.reduce((s,it)=>s + Number(it.amount||0), 0);
    const base = itemsTotal + sharedPerPerson + manualPerPerson;
    const gst = gstEnabled ? (base * 0.08) : 0;
    const total = base + gst;
    return {
      name: p.name,
      itemsTotal: round2(itemsTotal),
      sharedShare: round2(sharedPerPerson),
      manualShare: round2(manualPerPerson),
      gstShare: round2(gst),
      total: round2(total)
    };
  });

  const grandTotal = round2(lines.reduce((s,l)=>s + l.total, 0));
  return { lines, grandTotal, sharedPerPerson: round2(sharedPerPerson), manualPerPerson: round2(manualPerPerson) };
}

/* ===== preview & PDF ===== */
function openPreview(){
  if(persons.length === 0) return alert('ADD AT LEAST ONE PERSON');
  const vendor = el('#vendorSelect').value; if(!vendor) return alert('SELECT VENDOR');

  const date = el('#billDate').value || '-';
  const payer = el('#payerSelect').value || '-';
  const manualSvc = parseFloat(el('#manualService').value)||0;

  const { lines, grandTotal, sharedPerPerson, manualPerPerson } = computeTotalsDetailed();
  const rows = lines.map(l=>`
    <tr>
      <td style="font-weight:700">${l.name}</td>
      <td>
        Items: ${f2(l.itemsTotal)}<br/>
        Shared: ${f2(l.sharedShare)}<br/>
        Manual: ${f2(l.manualShare)}<br/>
        GST: ${f2(l.gstShare)}
      </td>
      <td style="text-align:right;font-weight:700">${f2(l.total)}</td>
    </tr>`).join('');

  openModal('PREVIEW BILL', `
    <div style="display:flex;flex-direction:column;gap:8px">
      <div style="display:flex;justify-content:space-between;gap:8px">
        <div class="tag">DATE: ${date}</div>
        <div class="tag">VENDOR: ${vendor}</div>
      </div>
      <div style="display:flex;justify-content:space-between;gap:8px">
        <div class="tag">PAYER: ${payer}</div>
        <div class="tag">GST: ${gstEnabled? 'ON':'OFF'}</div>
      </div>
      <div style="display:flex;justify-content:space-between;gap:8px">
        <div class="tag">SHARED / PERS: ${f2(sharedPerPerson)}</div>
        <div class="tag">MANUAL / PERS: ${f2(manualPerPerson)}</div>
      </div>

      <div class="table-wrap" style="margin-top:6px">
        <table>
          <thead><tr><th>Person</th><th>Breakdown</th><th style="text-align:right">Total</th></tr></thead>
          <tbody>${rows}</tbody>
          <tfoot><tr><th colspan="2" style="text-align:right">GRAND TOTAL</th><th style="text-align:right">${f2(grandTotal)}</th></tr></tfoot>
        </table>
      </div>
    </div>
  `, 'CONFIRM & GENERATE PDF', confirmGenerate);
}

function confirmGenerate(){
  const billDate = el('#billDate').value || '';
  const vendor = el('#vendorSelect').value || '';
  const payer = el('#payerSelect').value || '';
  const manualSvc = parseFloat(el('#manualService').value) || 0;

  const billData = {
    billID: billCounter,
    date: billDate,
    vendor, payer,
    gst: gstEnabled, manualService: manualSvc,
    persons: JSON.parse(JSON.stringify(persons)),
    sharedItems: JSON.parse(JSON.stringify(sharedItems))
  };

  const { lines } = computeTotalsDetailed();
  lines.forEach(l=>{
    if(l.name !== payer){
      owings.push({ billID: billCounter, date: billDate, payer, payee: l.name, amount: l.total, status: 'UNPAID' });
    }
  });

  bills.push(billData); saveLS(LS_BILLS, bills); saveLS(LS_OWINGS, owings);

  // PDF
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'pt', format:'a4'});
  let y = 40;
  doc.setFontSize(18); doc.setFont("helvetica","bold"); doc.text('KUDHIN SPLIT BILL', 40, y); y += 22;
  doc.setFontSize(11); doc.setFont("helvetica","normal");
  doc.text(`BILL ID: ${billCounter}`, 40, y); y += 14;
  doc.text(`DATE: ${billDate}`, 40, y); y += 14;
  doc.text(`VENDOR: ${vendor}`, 40, y); y += 14;
  doc.text(`PAYER: ${payer}`, 40, y); y += 16;
  doc.text(`GST 8%: ${gstEnabled ? 'YES' : 'NO'}`, 40, y); y += 14;
  doc.text(`MANUAL SERVICE TOTAL: ${manualSvc}`, 40, y); y += 18;

  doc.text('SHARED ITEMS:', 40, y); y += 14;
  if(sharedItems.length === 0){ doc.text('- NONE', 60, y); y += 14; }
  else { sharedItems.forEach(s=>{ doc.text(`- ${s.item}: ${f2(s.amount)}`, 60, y); y += 14; }); }
  y += 8;

  doc.text('PERSONS:', 40, y); y += 14;
  const { lines: finalLines, grandTotal } = computeTotalsDetailed();
  finalLines.forEach(fl=>{
    doc.text(`${fl.name}`, 40, y); y += 12;
    doc.text(`Items: ${f2(fl.itemsTotal)}  Shared: ${f2(fl.sharedShare)}  Manual: ${f2(fl.manualShare)}`, 50, y); y += 12;
    doc.text(`GST: ${f2(fl.gstShare)}  => TOTAL: ${f2(fl.total)}`, 50, y); y += 18;
    if(y > 720){ doc.addPage(); y = 40; }
  });
  doc.text(`GRAND TOTAL: ${f2(grandTotal)}`, 40, y);
  doc.save(`Bill_${billDate.replaceAll('-','') || billCounter}.pdf`);

  billCounter++;
  renderOwings();
  closeModal();
}

/* ===== Owings (card layout) ===== */
function renderOwings(){
  const area = el('#owingsArea'); area.innerHTML = '';
  if(owings.length === 0){
    area.innerHTML = `<div style="padding:18px;border-radius:12px;border:1px dashed #e6f7ff;background:#fbfeff;text-align:center;color:var(--muted)">No owings yet — generate a bill to create owings.</div>`;
    return;
  }
  const grouped = {};
  owings.forEach(o=>{ (grouped[o.billID] ||= {meta:o, items:[]}).items.push(o); });
  Object.keys(grouped).reverse().forEach(bid=>{
    const g = grouped[bid];
    const card = document.createElement('div'); card.className='owing-card';
    const top = document.createElement('div'); top.className='owing-top';
    const left = document.createElement('div'); left.style.flex='1'; left.innerHTML = `<div style="font-weight:800">Bill #${g.meta.billID}</div><div class="small" style="color:var(--muted)">${g.meta.date || '-'}</div>`;
    const right = document.createElement('div'); right.style.textAlign='right'; right.innerHTML = `<div style="font-weight:700">${g.meta.payer}</div><div class="small" style="color:var(--muted)">Payer</div>`;
    top.appendChild(left); top.appendChild(right); card.appendChild(top);

    g.items.forEach(it=>{
      const row = document.createElement('div'); row.style.cssText='display:flex;justify-content:space-between;align-items:center;margin-top:10px';
      const l = document.createElement('div'); l.innerHTML = `<div style="font-weight:700">${it.payee}</div><div class="small" style="color:var(--muted)">Owes to ${it.payer}</div>`;
      const r = document.createElement('div'); r.style.display='flex'; r.style.flexDirection='column'; r.style.alignItems='flex-end';
      const amt = document.createElement('div'); amt.style.fontWeight='800'; amt.textContent = f2(it.amount);
      const status = document.createElement('div'); status.className=`status ${it.status}`; status.textContent = it.status;
      const actions = document.createElement('div'); actions.style.marginTop='8px';
      const btn = document.createElement('button'); btn.className='btn btn-primary'; btn.textContent = (it.status==='UNPAID')?'Mark Paid':(it.status==='PAID'?'Confirm Received':'Done');
      btn.disabled = (it.status==='RECEIVED');
      btn.onclick = ()=>{ if(it.status==='UNPAID') it.status='PAID'; else if(it.status==='PAID') it.status='RECEIVED'; saveLS(LS_OWINGS, owings); renderOwings(); };
      r.appendChild(amt); r.appendChild(status); r.appendChild(actions); actions.appendChild(btn);
      row.appendChild(l); row.appendChild(r); card.appendChild(row);
    });
    area.appendChild(card);
  });
}

/* ===== utilities ===== */
function exportData(){ const data={users,vendors,owings,bills}; const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='kudhin_export.json'; a.click(); URL.revokeObjectURL(url); }
function clearAll(){
  if(!confirm('Clear all saved bills/owings/vendors? This cannot be undone.')) return;
  localStorage.removeItem(LS_VENDORS); localStorage.removeItem(LS_BILLS); localStorage.removeItem(LS_OWINGS);
  vendors=[]; bills=[]; owings=[]; refreshVendorSelect(); refreshVendorList(); renderOwings();
}

/* initial UI population */
refreshVendorSelect(); refreshVendorList(); updatePayerSelect(); renderUsers(); renderOwings();

/* ESC closes modal */
document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeModal(); });
</script>
</body>
</html>